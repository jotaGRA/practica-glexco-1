name: clase 2 - dependencies

on: push

jobs:
  # -----------------------------------------------------------------
  # 1. JOBS DE CONSTRUCCI√ìN (paralelos)
  # -----------------------------------------------------------------
  build-backend:
    runs-on: ubuntu-latest
    outputs:
      artifact: ${{ steps.upload.outputs.artifact }}
    steps:
      - name: Compilar backend
        run: echo "üî® Compilando backend..."
      - name: Subir artefacto (simulado)
        id: upload
        run: echo "artifact=backend-v1.0.0.jar" >> $GITHUB_OUTPUT

  build-frontend:
    runs-on: ubuntu-latest
    outputs:
      artifact: ${{ steps.upload.outputs.artifact }}
    steps:
      - name: Compilar frontend
        run: echo "üé® Compilando frontend..."
      - name: Subir artefacto
        id: upload
        run: echo "artifact=frontend-v1.0.0.zip" >> $GITHUB_OUTPUT

  # -----------------------------------------------------------------
  # 2. JOB DE INTEGRACI√ìN (depende de AMBOS builds)
  # -----------------------------------------------------------------
  integration:
    needs: [build-backend, build-frontend]   # Espera a que ambos terminen
    runs-on: ubuntu-latest
    steps:
      - name: Obtener artefactos
        run: |
          echo "üì¶ Backend: ${{ needs.build-backend.outputs.artifact }}"
          echo "üì¶ Frontend: ${{ needs.build-frontend.outputs.artifact }}"
      - name: Ejecutar pruebas de integraci√≥n
        run: echo "üß™ Probando integraci√≥n..."

  # -----------------------------------------------------------------
  # 3. MATRIZ DE PRUEBAS UNITARIAS (se ejecuta en paralelo)
  #    Depende solo de los builds, no de integration
  # -----------------------------------------------------------------
  test-unit:
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [backend, frontend]
        os: [ubuntu-latest, windows-latest]
    steps:
      - name: Probar ${{ matrix.component }} en ${{ matrix.os }}
        run: echo "‚úÖ Pruebas unitarias de ${{ matrix.component }} en ${{ matrix.os }}"

  # -----------------------------------------------------------------
  # 4. JOB DE CALIDAD (SONAR) - Depende solo del backend (ejemplo)
  # -----------------------------------------------------------------
  sonar:
    needs: build-backend
    runs-on: ubuntu-latest
    steps:
      - name: An√°lisis de calidad
        run: echo "üîç Escaneo de c√≥digo backend..."

  # -----------------------------------------------------------------
  # 5. DESPLIEGUE EN STAGING - Depende de integration Y test-unit
  # -----------------------------------------------------------------
  deploy-staging:
    needs: [integration, test-unit, sonar]
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Desplegar en staging
        run: echo "üöÄ Desplegando en staging..."

  # -----------------------------------------------------------------
  # 6. DESPLIEGUE EN PRODUCCI√ìN - Solo si staging fue exitoso
  #    Adem√°s, solo se ejecuta en la rama main
  # -----------------------------------------------------------------
  deploy-production:
    needs: deploy-staging
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Desplegar en producci√≥n
        run: echo "üî• Desplegando en producci√≥n..."

  # -----------------------------------------------------------------
  # 7. JOB DE LIMPIEZA - Se ejecuta SIEMPRE, incluso si falla algo
  # -----------------------------------------------------------------
  cleanup:
    needs: [deploy-staging, deploy-production]   # Espera a ambos (aunque uno no se ejecute)
    if: always()                                 # Se ejecuta pase lo que pase
    runs-on: ubuntu-latest
    steps:
      - name: Limpiar recursos temporales
        run: |
          echo "üßπ Eliminando recursos..."
          echo "Resultado de staging: ${{ needs.deploy-staging.result }}"
          echo "Resultado de producci√≥n: ${{ needs.deploy-production.result }}"