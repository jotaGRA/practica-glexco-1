name: Clase 2 - workflow dispatch

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'üåç Entorno destino'
        required: true
        default: 'staging'
        type: choice
        options:
          - dev
          - staging
          - production
      version:
        description: 'üì¶ Versi√≥n a desplegar (ej: v1.2.3)'
        required: true
        type: string
      region:
        description: 'üåé Regi√≥n del despliegue'
        required: false
        default: 'us-east-1'
        type: choice
        options:
          - us-east-1
          - eu-west-1
          - ap-southeast-1
      run_tests:
        description: 'üß™ Ejecutar suite de pruebas'
        required: false
        default: true
        type: boolean
      debug_mode:
        description: 'üêõ Activar modo debug (logs verbosos)'
        required: false
        default: false
        type: boolean
      max_retries:
        description: 'üîÑ N√∫mero m√°ximo de reintentos'
        required: false
        default: 3
        type: number
      notify_slack:
        description: 'üîî Enviar notificaci√≥n a Slack'
        required: false
        default: true
        type: boolean

# Variables de entorno globales
env:
  APP_NAME: "mi-app-clase"
  DOCKER_REGISTRY: "ghcr.io/${{ github.repository }}"

jobs:
  # 1. VALIDACI√ìN DE ENTRADAS
  validate-inputs:
    runs-on: ubuntu-latest
    steps:
      - name: Validar formato de versi√≥n (semver)
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "prueba: ${{ github.event.inputs.prueba }}"
          echo "test2: ${{ github.event.inputs.test2 }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå La versi√≥n debe tener formato semver (ej: v1.2.3)"
            exit 1
          fi
          echo "‚úÖ Versi√≥n v√°lida: $VERSION"

      - name: Verificar entorno de producci√≥n solo en rama main
        if: ${{ github.event.inputs.environment == 'production' && github.ref != 'refs/heads/main' }}
        run: |
          echo "‚ùå Solo se puede desplegar a producci√≥n desde la rama main"
          exit 1

  # 2. CONSTRUCCI√ìN Y SUBIDA DE IMAGEN (simulada)
  build:
    needs: validate-inputs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Simular build
        run: |
          echo "üî® Construyendo imagen para ${{ env.APP_NAME }}:${{ github.event.inputs.version }}"
          echo "Registro: ${{ env.DOCKER_REGISTRY }}"
          # docker build -t $DOCKER_REGISTRY/$APP_NAME:$VERSION .
      - name: Subir artefacto (simulado)
        run: |
          echo "üì¶ Subiendo imagen a ${{ env.DOCKER_REGISTRY }}"

  # 3. PRUEBAS (condicionadas por input run_tests)
  test:
    needs: build
    if: ${{ github.event.inputs.run_tests == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-suite: [unit, integration, e2e]
    steps:
      - name: Ejecutar pruebas ${{ matrix.test-suite }}
        run: |
          echo "üß™ Corriendo pruebas ${{ matrix.test-suite }}..."
          sleep 2
          echo "‚úÖ Pruebas ${{ matrix.test-suite }} pasaron"

  # 4. DESPLIEGUE POR ENTORNO (usa GitHub Environments)
  deploy:
    needs: [build, test]
    if: ${{ always() && needs.build.result == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
      url: ${{ steps.deploy-url.outputs.url }}
    env:
      ENV_SECRET: ${{ secrets.API_KEY }}  # Depende del entorno configurado
    steps:
      - name: Configurar AWS CLI (simulado)
        if: ${{ github.event.inputs.region != '' }}
        run: |
          echo "üåé Configurando regi√≥n ${{ github.event.inputs.region }}"
      - name: Desplegar aplicaci√≥n
        id: deploy
        run: |
          echo "üöÄ Desplegando ${{ env.APP_NAME }}:${{ github.event.inputs.version }} en ${{ github.event.inputs.environment }}"
          echo "Modo debug: ${{ github.event.inputs.debug_mode }}"
          echo "Reintentos m√°ximos: ${{ github.event.inputs.max_retries }}"
          # Simular URL de despliegue
          URL="https://${{ github.event.inputs.environment }}.${{ env.APP_NAME }}.com"
          echo "url=$URL" >> $GITHUB_OUTPUT
      - name: Verificar salud
        run: |
          echo "ü©∫ Verificando endpoint: ${{ steps.deploy.outputs.url }}"
          # curl -f $URL

  # 5. NOTIFICACI√ìN (condicionada)
  notify:
    needs: deploy
    if: ${{ always() && github.event.inputs.notify_slack == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Enviar notificaci√≥n a Slack (simulado)
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Despliegue exitoso en ${{ github.event.inputs.environment }}"
          else
            echo "‚ùå Fallo en despliegue en ${{ github.event.inputs.environment }}"
          fi
          echo "üîî Notificaci√≥n enviada a Slack (webhook ${{ secrets.SLACK_WEBHOOK }})"