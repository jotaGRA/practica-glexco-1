# Workflow que solo ejecuta tests según qué rutas del repo cambiaron.
# Usa path filters a nivel de evento y detección fina con dorny/paths-filter.

name: Clase 2 - path filters and types OPENED

on:
  # Trigger 1: Pull Request
  # Solo se dispara cuando se abre un PR que toca estas rutas
  pull_request:
    types: [opened]
    paths:
      - 'src/backend/**'
      - 'src/frontend/**'
      - 'tests/**'

  # Trigger 2: Push directo a ramas principales
  # Solo se dispara en push a main/develop/release/* que toquen estas rutas
  push:
    branches:
      - main
      - develop
      - 'release/**'
    paths:
      - 'src/backend/**'
      - 'src/frontend/**'
      - 'tests/**'

jobs:
  # Job que detecta qué conjuntos de rutas cambiaron (backend, frontend, tests).
  # Sus outputs los usan los jobs de test para decidir si se ejecutan o no.
  detect-changes:
    runs-on: ubuntu-latest
    # Exponer los resultados del step "filter" para que otros jobs los lean con needs.detect-changes.outputs.*
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      tests: ${{ steps.filter.outputs.tests }}
      prueba: ${{ steps.mi-step-prueba.outputs.prueba }}
    steps:
      # Necesario para que paths-filter pueda comparar con el commit anterior
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mostrar prueba
        id: mi-step-prueba
        run: | 
          echo "prueba=prueba34" >> $GITHUB_OUTPUT


      # Compara el diff contra las rutas definidas y escribe "true"/"false" en cada output
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          # En push: comparar con commit anterior. En PR: comparar con la base del PR
          base: ${{ github.event_name == 'push' && github.event.before || github.base_ref }}
          filters: |
            backend:
              - 'src/backend/**'
            frontend:
              - 'src/frontend/**'
            tests:
              - 'tests/**'

  # Solo corre si hubo cambios en src/backend/**
  test-backend:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Instalar dependencias backend
        run: echo "Instalando paquetes de backend..."
      - name: Ejecutar pruebas de backend
        run: echo "Corriendo tests de backend..."
      - name: Usar output del job detect-changes
        run: echo "El valor de prueba es ${{ needs.detect-changes.outputs.prueba }}"

  # Solo corre si hubo cambios en src/frontend/**
  test-frontend:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Instalar dependencias frontend
        run: echo "Instalando paquetes de frontend..."
      - name: Ejecutar pruebas de frontend
        run: echo "Corriendo tests de frontend..."

  # Solo corre si hubo cambios en tests/**
  test-unit:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.tests == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ejecutar suite de pruebas unitarias
        run: echo "Corriendo tests unitarios generales..."
