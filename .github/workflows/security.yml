name: clase 2 - security

on:
  push:
    branches: [main, develop]
  workflow_dispatch:  # Para pruebas manuales

jobs:
  # ------------------------------------------------------------
  # ENTORNO DE DESARROLLO (dev) - Sin protecciÃ³n especial
  # ------------------------------------------------------------
  deploy-dev:
    runs-on: ubuntu-latest
    environment:
      name: dev
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Desplegar en Dev
        id: deploy
        env:
          API_KEY: ${{ secrets.API_KEY }}        # Secreto propio de dev
          ENV_TYPE: ${{ vars.ENVIRONMENT_TYPE }} # Variable de entorno (dev)
        run: |
          echo "ðŸ”§ Desplegando en entorno DEV"
          echo "   Usando API_KEY: $API_KEY (primeros 4 chars: ${API_KEY:0:4}...)"
          echo "   Tipo de entorno: $ENV_TYPE"
          echo "url=http://dev.miapp.com" >> $GITHUB_OUTPUT

  # ------------------------------------------------------------
  # ENTORNO DE STAGING - ProtecciÃ³n: rama y reviewers
  # ------------------------------------------------------------
  deploy-staging:
    needs: deploy-dev
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    # Solo se ejecuta si la rama es 'develop' o 'main' (protecciÃ³n)
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Verificar aprobaciÃ³n manual (simulada)
        run: |
          echo "â³ Esperando aprobaciÃ³n manual..."
          # En un entorno real, GitHub pausa el workflow automÃ¡ticamente
          # hasta que un reviewer apruebe el despliegue en staging.

      - name: Desplegar en Staging
        id: deploy
        env:
          STAGING_TOKEN: ${{ secrets.STAGING_TOKEN }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL }}
        run: |
          echo "ðŸš€ Desplegando en STAGING"
          echo "   Token: ${STAGING_TOKEN:0:4}..."
          echo "   Log level: $LOG_LEVEL"
          echo "url=https://staging.miapp.com" >> $GITHUB_OUTPUT

  # ------------------------------------------------------------
  # ENTORNO DE PRODUCCIÃ“N - ProtecciÃ³n mÃ¡xima
  # ------------------------------------------------------------
  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    # Condiciones de entorno (se combinan con las reglas de protecciÃ³n)
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Desplegar en ProducciÃ³n
        id: deploy
        env:
          PROD_TOKEN: ${{ secrets.PROD_TOKEN }}
          RELEASE_VERSION: ${{ vars.RELEASE_VERSION }}
        run: |
          echo "ðŸ”¥ Desplegando en PRODUCCIÃ“N"
          echo "   Token: ${PROD_TOKEN:0:4}..."
          echo "   VersiÃ³n: $RELEASE_VERSION"
          echo "url=https://miapp.com" >> $GITHUB_OUTPUT

      - name: Post-despliegue (health check)
        run: |
          echo "ðŸ©º Verificando estado de producciÃ³n..."
          sleep 2
          echo "âœ… Todos los sistemas operan normalmente."

  # ------------------------------------------------------------
  # NOTIFICACIÃ“N FINAL
  # ------------------------------------------------------------
  notify:
    needs: [deploy-dev, deploy-staging, deploy-production]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Enviar resumen
        run: |
          echo "ðŸ“¬ Resumen de despliegues:"
          echo "  Dev: ${{ needs.deploy-dev.result }}"
          echo "  Staging: ${{ needs.deploy-staging.result }}"
          echo "  ProducciÃ³n: ${{ needs.deploy-production.result }}"